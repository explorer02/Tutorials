<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>

        class Student {
            constructor(id, reading, ref = undefined) {
                this._id = id;
                this._reading = reading;
                this.domref = ref;
            }
            get id() {
                return this._id;
            }
            set id(newId) {
                //TODO: remove this
                if (!this.domref.checkStudExist(this.id) || this.domref.checkStudExist(newId))
                    return;
                let change = (newId !== this._id);
                if (change) {
                    this.domref.studs[newId] = this
                    delete this.domref.studs[this.id]
                    this._id = newId;
                    this.domref.startTimer();
                }

            }
            get reading() {
                return this._reading;
            }
            set reading(newReading) {
                if (!this.domref.checkStudExist(this.id))
                    return
                let change = (newReading !== this._reading);
                this._reading = newReading;
                if (change)
                    this.domref.startTimer();
            }
        }

        ////////////////////////////////////////////

        class StudentDom {
            constructor(studs, time) {
                let studsCopy = studs.map(stud => this.deepCopy(stud));
                this.studs = {}
                studsCopy.forEach(stud => {
                    this.studs[stud.id] = stud;
                })
                this.time = time;
                this.timerID = undefined;
            }
            deepCopy(stud) {
                return new Student(stud.id, stud.reading, this);
            }
            getStudentById(id) {
                return this.studs[id];
            }
            append(stud) {
                this.studs[stud.id] = new Student(stud.id, stud.reading, this);
                this.startTimer();
            }
            remove(id) {
                let change = this.studs[id];
                delete this.studs[id]
                if (change)
                    this.startTimer();
            }
            checkStudExist(id) {
                if (this.studs[id])
                    return true;
            }
            startTimer() {
                if (!this.timerID) {
                    this.timerID = setTimeout(() => this.reflectChanges(), this.time);
                }
            }
            stopTimer() {
                this.timerID = undefined;
            }
            reflectChanges() {
                console.log(this.studs);
                this.stopTimer();
            }
        }

        //////////////////////////////////////

        let studs = [
            new Student(1, true),
            new Student(2, false),
            new Student(3, false),
            new Student(4, true),
            new Student(5, true)
        ];

        let newStud = new Student(6, false);

        let dom = new StudentDom(studs, 2000);

    </script>
</body>

</html>